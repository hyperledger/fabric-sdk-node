<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Hyperledger Fabric SDK for Node.js Tutorial: fabric-common: Working with an offline private key</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Hyperledger Fabric SDK for Node.js</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-fabric-network.html">fabric-network</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="AffiliationService.html">AffiliationService</a></li><li><a href="BaseClient.html">BaseClient</a></li><li><a href="BlockDecoder.html">BlockDecoder</a></li><li><a href="global.html#ChaincodeEvent">ChaincodeEvent</a></li><li><a href="Channel.html">Channel</a></li><li><a href="Client.html">Client</a></li><li><a href="Commit.html">Commit</a></li><li><a href="Committer.html">Committer</a></li><li><a href="CryptoKeyStore.html">CryptoKeyStore</a></li><li><a href="CryptoSuite.html">CryptoSuite</a></li><li><a href="CryptoSuite_ECDSA_AES.html">CryptoSuite_ECDSA_AES</a></li><li><a href="CryptoSuite_PKCS11.html">CryptoSuite_PKCS11</a></li><li><a href="Discoverer.html">Discoverer</a></li><li><a href="DiscoveryHandler.html">DiscoveryHandler</a></li><li><a href="DiscoveryService.html">DiscoveryService</a></li><li><a href="ECDSA_KEY.html">ECDSA_KEY</a></li><li><a href="global.html#Endorsement">Endorsement</a></li><li><a href="Endorser.html">Endorser</a></li><li><a href="Endpoint.html">Endpoint</a></li><li><a href="Eventer.html">Eventer</a></li><li><a href="global.html#EventInfo">EventInfo</a></li><li><a href="EventService.html">EventService</a></li><li><a href="FabricCAClient.html">FabricCAClient</a></li><li><a href="FabricCAServices.html">FabricCAServices</a></li><li><a href="Hash.html">Hash</a></li><li><a href="Identity.html">Identity</a></li><li><a href="IdentityContext.html">IdentityContext</a></li><li><a href="IdentityService.html">IdentityService</a></li><li><a href="InMemoryKeyValueStore.html">InMemoryKeyValueStore</a></li><li><a href="Key.html">Key</a></li><li><a href="KeyValueStore.html">KeyValueStore</a></li><li><a href="module.exports_module.exports.html">module.exports#module.exports</a></li><li><a href="module-fabric-network.DefaultCheckpointers.html">fabric-network.DefaultCheckpointers</a></li><li><a href="module-fabric-network.FabricError.html">fabric-network.FabricError</a></li><li><a href="module-fabric-network.Gateway.html">fabric-network.Gateway</a></li><li><a href="module-fabric-network.HsmX509Provider.html">fabric-network.HsmX509Provider</a></li><li><a href="module-fabric-network.IdentityProviderRegistry.html">fabric-network.IdentityProviderRegistry</a></li><li><a href="module-fabric-network.TimeoutError.html">fabric-network.TimeoutError</a></li><li><a href="module-fabric-network.Transaction.html">fabric-network.Transaction</a></li><li><a href="module-fabric-network.Wallet.html">fabric-network.Wallet</a></li><li><a href="module-fabric-network.Wallets.html">fabric-network.Wallets</a></li><li><a href="PKCS11_ECDSA_KEY.html">PKCS11_ECDSA_KEY</a></li><li><a href="Proposal.html">Proposal</a></li><li><a href="Query.html">Query</a></li><li><a href="ServiceAction.html">ServiceAction</a></li><li><a href="ServiceEndpoint.html">ServiceEndpoint</a></li><li><a href="ServiceHandler.html">ServiceHandler</a></li><li><a href="Signer.html">Signer</a></li><li><a href="SigningIdentity.html">SigningIdentity</a></li><li><a href="User.html">User</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="interfaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Interfaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-fabric-network.BlockEvent.html">fabric-network.BlockEvent</a></li><li><a href="module-fabric-network.Checkpointer.html">fabric-network.Checkpointer</a></li><li><a href="module-fabric-network.CommitError.html">fabric-network.CommitError</a></li><li><a href="module-fabric-network.CommitEvent.html">fabric-network.CommitEvent</a></li><li><a href="module-fabric-network.Contract.html">fabric-network.Contract</a></li><li><a href="module-fabric-network.ContractEvent.html">fabric-network.ContractEvent</a></li><li><a href="module-fabric-network.DefaultEventHandlerOptions.html">fabric-network.DefaultEventHandlerOptions</a></li><li><a href="module-fabric-network.DefaultQueryHandlerOptions.html">fabric-network.DefaultQueryHandlerOptions</a></li><li><a href="module-fabric-network.DiscoveryOptions.html">fabric-network.DiscoveryOptions</a></li><li><a href="module-fabric-network.GatewayOptions.html">fabric-network.GatewayOptions</a></li><li><a href="module-fabric-network.HsmOptions.html">fabric-network.HsmOptions</a></li><li><a href="module-fabric-network.HsmX509Identity.html">fabric-network.HsmX509Identity</a></li><li><a href="module-fabric-network.Identity.html">fabric-network.Identity</a></li><li><a href="module-fabric-network.IdentityProvider.html">fabric-network.IdentityProvider</a></li><li><a href="module-fabric-network.ListenerOptions.html">fabric-network.ListenerOptions</a></li><li><a href="module-fabric-network.Network.html">fabric-network.Network</a></li><li><a href="module-fabric-network.Query.html">fabric-network.Query</a></li><li><a href="module-fabric-network.QueryHandler.html">fabric-network.QueryHandler</a></li><li><a href="module-fabric-network.TransactionEvent.html">fabric-network.TransactionEvent</a></li><li><a href="module-fabric-network.TxEventHandler.html">fabric-network.TxEventHandler</a></li><li><a href="module-fabric-network.WalletStore.html">fabric-network.WalletStore</a></li><li><a href="module-fabric-network.X509Identity.html">fabric-network.X509Identity</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="tutorial-commonconnectionprofile.html">commonconnectionprofile</a></li><li><a href="tutorial-discovery-fabric-network.html">fabric-network: How to use the discovery service</a></li><li><a href="tutorial-grpc-settings.html">fabric-common: How to set gRPC settings</a></li><li><a href="tutorial-handlers.html">fabric-common: How to use the endorsement, query, and commit handlers</a></li><li><a href="tutorial-logging.html">fabric-common: How to use logging</a></li><li><a href="tutorial-migration.html">Migrating client applications from v1.4 to v2.0</a></li><li><a href="tutorial-query-peers.html">fabric-network: How to select peers for evaluating transactions (queries)</a></li><li><a href="tutorial-sign-transaction-offline.html">fabric-common: Working with an offline private key</a></li><li><a href="tutorial-transaction-commit-events.html">fabric-network: How to wait for transactions to be committed to the ledger</a></li><li><a href="tutorial-wallet.html">fabric-network: Using wallets to manage identities</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#bitsToBytes">bitsToBytes</a></li><li><a href="global.html#bytesToBits">bytesToBits</a></li><li><a href="global.html#CLIENT">CLIENT</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#HFAFFILIATIONMGR">HFAFFILIATIONMGR</a></li><li><a href="global.html#HFGENCRL">HFGENCRL</a></li><li><a href="global.html#HFINTERMEDIATECA">HFINTERMEDIATECA</a></li><li><a href="global.html#HFREGISTRARATTRIBUTES">HFREGISTRARATTRIBUTES</a></li><li><a href="global.html#HFREGISTRARDELEGATEROLES">HFREGISTRARDELEGATEROLES</a></li><li><a href="global.html#HFREGISTRARROLES">HFREGISTRARROLES</a></li><li><a href="global.html#HFREVOKER">HFREVOKER</a></li><li><a href="global.html#newCryptoKeyStore">newCryptoKeyStore</a></li><li><a href="global.html#newCryptoSuite">newCryptoSuite</a></li><li><a href="global.html#ORDERER">ORDERER</a></li><li><a href="global.html#PEER">PEER</a></li><li><a href="global.html#setLogger">setLogger</a></li><li><a href="global.html#TYPE">TYPE</a></li><li><a href="global.html#USER">USER</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			<section class="tutorial-section">

<header>
    

    <h2>fabric-common: Working with an offline private key</h2>
</header>

<article>
    <p>This tutorial illustrates how to work with an offline private key with the
Hyperledger Fabric Node.js SDK (fabric-common and fabric-ca-client) APIs.</p>
<p>For more information on:</p>
<ul>
<li>getting started with Hyperledger Fabric see
<a href="http://hyperledger-fabric.readthedocs.io/en/latest/build_network.html">Building your first network</a>.</li>
<li>The transactional mechanics that take place during a standard asset exchange.
<a href="https://hyperledger-fabric.readthedocs.io/en/latest/txflow.html">transacton flow in fabric</a>.</li>
<li>The Certificate Signing Request (CSR) in a PKI system.
<a href="https://en.wikipedia.org/wiki/Certificate_signing_request">CSR</a></li>
</ul>
<p>The following assumes an understanding of the Hyperledger Fabric network
(orderers and peers),
and of Node application development, including the use of the
Javascript <code>promise</code> and <code>async await</code>.</p>
<h2>Overview</h2>
<p>In most use cases an application will persist the user's credentials including
the private key and sign transactions for the user. However some business
scenarios may require higher level of privacy. What if the user wants to
keep their private key secret and does not trust another system or backend
server to securely store it and use it?</p>
<p>The <code>fabric-common</code> package comes with the ability to sign a transaction outside
of the application. The application may choose to include the signature when
calling the <code>send</code> method of the service instead of the identity context
that would be used to create the signature.</p>
<p>The Fabric-ca comes with the ability to enroll with a PKCS#10 standard CSR,
which means the user can use an existing key pairs to generate the CSR and
send this CSR to Fabric-ca to get the signed certificate.<br>
The <code>fabric-ca-client</code> also accepts a CSR at the API <code>enroll()</code>.</p>
<h2>How to sign a transaction by an identity's private key</h2>
<p>There might be several digital signature algorithms. If we set the user's
identity at the fabric client, the fabric client would use ECDSA with
algorithm 'EC' by default.</p>
<p>The process is the same for all Service of <code>Endorsement</code>, <code>Commit</code>, <code>Query</code>,
and <code>Discovery</code>, using first the <code>build()</code> method getting the bytes to be
signed. Signing those bytes, then providing the signagure on the <code>sign()</code>
method before calling the <code>send()</code>.</p>
<ol>
<li>
<p>generate proposal bytes with the identity's certificate</p>
<pre class="prettyprint source lang-javascript"><code>const idx = client.newIdentityContext(user);
const endorsement = channel.newEndorsement(chaincode_name);

const build_options = {fcn: 'move', args: ['a', 'b', '100']};
const proposalBytes = endorsement.build(idx, build_options);
</code></pre>
</li>
<li>
<p>calculate the hash</p>
<p>A hash algorithm should be picked and calculate the hash of the transaction
proposal bytes.</p>
<p>There exists multiple hash functions (such as SHA2/3). by default,
the fabric client will use 'SHA2' with key size 256.</p>
<p>The user may use an alternative implementation</p>
<pre class="prettyprint source lang-javascript"><code>const hashFunction = xxxx; // A hash function by the user's desire

const digest = hashFunction(proposalBytes); // calculate the hash of the proposal bytes
</code></pre>
</li>
<li>
<p>calculate the signature</p>
<p>We may have a series of choices for the signature algorithm. Including
asymmetric keys (such as ECDSA or RSA), symmetric keys (such as AES).</p>
<p>By default the the fabric client will use ECDSA with algorithm 'EC'.</p>
<pre class="prettyprint source lang-javascript"><code>// This is a sample code for signing the digest from step 2 with EC.
// Different signature algorithm may have different interfaces

const elliptic = require('elliptic');
const { KEYUTIL } = require('jsrsasign');

const privateKeyPEM = '&lt;The PEM encoded private key>';
const { prvKeyHex } = KEYUTIL.getKey(privateKeyPEM); // convert the pem encoded key to hex encoded private key

const EC = elliptic.ec;
const ecdsaCurve = elliptic.curves['p256'];

const ecdsa = new EC(ecdsaCurve);
const signKey = ecdsa.keyFromPrivate(prvKeyHex, 'hex');
const sig = ecdsa.sign(Buffer.from(digest, 'hex'), signKey);

// now we have the signature, next we should send the signed transaction proposal to the peer
const signature = Buffer.from(sig.toDER());
</code></pre>
</li>
<li>
<p>use the signature for transaction proposal to peer(s)</p>
<pre class="prettyprint source lang-javascript"><code>
endorsement.sign(signature);
const proposalResponses = await endorsement.send();
</code></pre>
</li>
</ol>
<h2>How to enroll with a CSR</h2>
<p>The <code>fabric-ca-client</code> provides the API <code>enroll()</code> that accepts an optional param 'CSR'.
If the params does not contains CSR, <code>fabric-ca-client</code> will first generate a key pair,
then use the user's enrollmentID as the common name to create a CSR which is signed with
the new generated private key. The response will contain the private key object if no 'CSR'
in enroll params.</p>
<p>To enroll with a CSR, first we should call <code>fabric-ca-client</code> API <code>register</code> to register
a new identity at Fabric-ca. After a successfully register, we have the <code>enrollmentID</code>
and <code>enrollmentSecret</code>.</p>
<p>Then we should create the CSR. A common way is using the <code>openssl</code> command.</p>
<blockquote>
<p>Notice the CSR must contain the information &quot;common name&quot; and the &quot;common name&quot; must be
same as the &quot;enrollmentID&quot; at the register step.</p>
</blockquote>
<p>Here is an example of how to create a CSR with the key algorithm rsa and key size 2048 bits</p>
<pre class="prettyprint source"><code>openssl req -nodes -newkey rsa:2048 -keyout test.key -out test.csr
</code></pre>
<p>The <code>test.csr</code> from the above command is represented as a Base64 encoded PKCS#10.</p>
<p>Here is how we call enroll with a CSR</p>
<pre class="prettyprint source lang-javascript"><code>const fs = require('fs');
const csr = fs.readFileSync('the path to test.csr', 'utf8');
const req = {
    enrollmentID: enrollmentID,
    enrollmentSecret: enrollmentSecret,
    csr: csr,
};

const enrollment = await caService.enroll(req);
// the enrollment.certificate contains the signed certificate from Fabric-ca
</code></pre>
</article>

</section>

		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a>
	
		on 2020-06-12T15:45:01+00:00
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : false,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>